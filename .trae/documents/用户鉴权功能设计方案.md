# 用户鉴权功能设计方案

## 一、当前系统角色定义

| 角色ID | 角色名称 | 描述 |
|--------|----------|------|
| `SYSTEM_ADMIN` | 系统管理员 | 拥有全系统最高管理权限 |
| `APPROVAL_ADMIN` | 审批负责人 | 负责各类资源申请的业务审核 |
| `MEETING_SERVICE` | 会议服务 | 负责会议室管理和准备工作 |
| `EMPLOYEE` | 正式员工 | 可申请并使用公司公共资源 |

## 二、功能模块清单

### 2.1 底部导航栏功能

| 模块ID | 模块名称 | 描述 |
|--------|----------|------|
| `DASHBOARD` | 首页 | 数据概览、快捷入口 |
| `RESOURCES` | 资源 | 资源列表、预约入口 |
| `MEETING_SERVICE` | 会议服务 | 会议室预约管理（会议服务角色专属） |
| `APPROVAL_CENTER` | 审批 | 审批中心（审批负责人角色专属） |
| `PROFILE` | 我的 | 个人中心 |

### 2.2 个人中心子功能

| 功能ID | 功能名称 | 描述 |
|--------|----------|------|
| `BOOKINGS` | 我的申请 | 查看个人预约记录 |
| `PROFILE_EDIT` | 个人信息 | 编辑个人信息 |
| `USERS` | 成员中心 | 用户管理 |
| `ROLES` | 角色管理 | 角色定义管理 |
| `DEPARTMENTS` | 部门管理 | 部门架构管理 |
| `RESOURCES_MANAGE` | 资源管理 | 资源增删改查 |
| `WORKFLOW_CONFIG` | 流程配置 | 审批流程配置 |
| `DATA_CENTER` | 数据中心 | 数据导出备份 |

## 三、权限矩阵设计

### 3.1 功能权限矩阵

| 功能模块 | 系统管理员 | 审批负责人 | 会议服务 | 正式员工 |
|----------|:----------:|:----------:|:--------:|:--------:|
| **底部导航** |
| 首页 | ✅ | ✅ | ✅ | ✅ |
| 资源 | ✅ | ✅ | ✅ | ✅ |
| 会议服务 | ✅ | ❌ | ✅ | ❌ |
| 审批 | ✅ | ✅ | ❌ | ❌ |
| 我的 | ✅ | ✅ | ✅ | ✅ |
| **个人中心** |
| 我的申请 | ✅ | ✅ | ✅ | ✅ |
| 个人信息 | ✅ | ✅ | ✅ | ✅ |
| 成员中心 | ✅ | ❌ | ❌ | ❌ |
| 角色管理 | ✅ | ❌ | ❌ | ❌ |
| 部门管理 | ✅ | ❌ | ❌ | ❌ |
| 资源管理 | ✅ | ❌ | ❌ | ❌ |
| 流程配置 | ✅ | ❌ | ❌ | ❌ |
| 数据中心 | ✅ | ❌ | ❌ | ❌ |

### 3.2 数据权限矩阵

| 数据类型 | 系统管理员 | 审批负责人 | 会议服务 | 正式员工 |
|----------|:----------:|:----------:|:--------:|:--------:|
| **预约记录** |
| 查看全部 | ✅ | ✅ | ✅(仅会议室) | ❌ |
| 查看本人 | ✅ | ✅ | ✅ | ✅ |
| 创建预约 | ✅ | ✅ | ✅ | ✅ |
| 撤销预约 | ✅ | ✅(本人) | ✅(本人) | ✅(本人) |
| 审批预约 | ✅ | ✅ | ❌ | ❌ |
| **用户数据** |
| 查看全部 | ✅ | ❌ | ❌ | ❌ |
| 编辑全部 | ✅ | ❌ | ❌ | ❌ |
| 编辑本人 | ✅ | ✅ | ✅ | ✅ |
| **资源数据** |
| 查看全部 | ✅ | ✅ | ✅ | ✅ |
| 管理资源 | ✅ | ❌ | ❌ | ❌ |

## 四、技术实现方案

### 4.1 权限配置文件

创建 `permissions.ts` 文件，定义权限映射：

```typescript
// 权限定义
export const PERMISSIONS = {
  // 底部导航
  VIEW_DASHBOARD: 'VIEW_DASHBOARD',
  VIEW_RESOURCES: 'VIEW_RESOURCES',
  VIEW_MEETING_SERVICE: 'VIEW_MEETING_SERVICE',
  VIEW_APPROVAL_CENTER: 'VIEW_APPROVAL_CENTER',
  VIEW_PROFILE: 'VIEW_PROFILE',
  
  // 个人中心功能
  VIEW_BOOKINGS: 'VIEW_BOOKINGS',
  EDIT_PROFILE: 'EDIT_PROFILE',
  MANAGE_USERS: 'MANAGE_USERS',
  MANAGE_ROLES: 'MANAGE_ROLES',
  MANAGE_DEPARTMENTS: 'MANAGE_DEPARTMENTS',
  MANAGE_RESOURCES: 'MANAGE_RESOURCES',
  CONFIG_WORKFLOW: 'CONFIG_WORKFLOW',
  ACCESS_DATA_CENTER: 'ACCESS_DATA_CENTER',
  
  // 数据权限
  VIEW_ALL_BOOKINGS: 'VIEW_ALL_BOOKINGS',
  APPROVE_BOOKINGS: 'APPROVE_BOOKINGS',
  VIEW_ALL_USERS: 'VIEW_ALL_USERS',
  EDIT_ALL_USERS: 'EDIT_ALL_USERS',
} as const;

// 角色-权限映射
export const ROLE_PERMISSIONS: Record<string, string[]> = {
  SYSTEM_ADMIN: [
    // 全部权限
    ...Object.values(PERMISSIONS),
  ],
  APPROVAL_ADMIN: [
    VIEW_DASHBOARD,
    VIEW_RESOURCES,
    VIEW_APPROVAL_CENTER,
    VIEW_PROFILE,
    VIEW_BOOKINGS,
    EDIT_PROFILE,
    VIEW_ALL_BOOKINGS,
    APPROVE_BOOKINGS,
  ],
  MEETING_SERVICE: [
    VIEW_DASHBOARD,
    VIEW_RESOURCES,
    VIEW_MEETING_SERVICE,
    VIEW_PROFILE,
    VIEW_BOOKINGS,
    EDIT_PROFILE,
    VIEW_ALL_BOOKINGS, // 仅会议室
  ],
  EMPLOYEE: [
    VIEW_DASHBOARD,
    VIEW_RESOURCES,
    VIEW_PROFILE,
    VIEW_BOOKINGS,
    EDIT_PROFILE,
  ],
};
```

### 4.2 权限检查 Hook

创建 `usePermissions.ts` Hook：

```typescript
import { useMemo } from 'react';
import { ROLE_PERMISSIONS, PERMISSIONS } from '../permissions';

export function usePermissions(userRoles: string[]) {
  const permissions = useMemo(() => {
    const allPermissions = new Set<string>();
    userRoles.forEach(role => {
      const rolePerms = ROLE_PERMISSIONS[role] || [];
      rolePerms.forEach(perm => allPermissions.add(perm));
    });
    return allPermissions;
  }, [userRoles]);

  const hasPermission = (permission: string): boolean => {
    return permissions.has(permission);
  };

  const hasAnyPermission = (perms: string[]): boolean => {
    return perms.some(p => permissions.has(p));
  };

  const hasAllPermissions = (perms: string[]): boolean => {
    return perms.every(p => permissions.has(p));
  };

  const hasRole = (role: string): boolean => {
    return userRoles.includes(role);
  };

  return {
    permissions,
    hasPermission,
    hasAnyPermission,
    hasAllPermissions,
    hasRole,
  };
}
```

### 4.3 权限组件

创建 `PermissionGuard.tsx` 组件：

```typescript
import React from 'react';
import { usePermissions } from '../hooks/usePermissions';

interface PermissionGuardProps {
  userRoles: string[];
  requiredPermissions?: string | string[];
  requireAll?: boolean;
  fallback?: React.ReactNode;
  children: React.ReactNode;
}

export const PermissionGuard: React.FC<PermissionGuardProps> = ({
  userRoles,
  requiredPermissions,
  requireAll = false,
  fallback = null,
  children,
}) => {
  const { hasPermission, hasAnyPermission, hasAllPermissions } = usePermissions(userRoles);

  if (!requiredPermissions) {
    return <>{children}</>;
  }

  const perms = Array.isArray(requiredPermissions) 
    ? requiredPermissions 
    : [requiredPermissions];

  const hasAccess = requireAll
    ? hasAllPermissions(perms)
    : hasAnyPermission(perms);

  return hasAccess ? <>{children}</> : <>{fallback}</>;
};
```

### 4.4 底部导航栏改造

```typescript
// BottomNav.tsx
import { PERMISSIONS } from '../permissions';

const NAV_ITEMS = [
  { id: 'DASHBOARD', icon: Home, label: '首页', permission: PERMISSIONS.VIEW_DASHBOARD },
  { id: 'RESOURCES', icon: MapPin, label: '资源', permission: PERMISSIONS.VIEW_RESOURCES },
  { id: 'MEETING_SERVICE', icon: Coffee, label: '会议服务', permission: PERMISSIONS.VIEW_MEETING_SERVICE },
  { id: 'APPROVAL_CENTER', icon: ClipboardList, label: '审批', permission: PERMISSIONS.VIEW_APPROVAL_CENTER },
  { id: 'PROFILE', icon: User, label: '我的', permission: PERMISSIONS.VIEW_PROFILE },
];

// 根据权限过滤导航项
const visibleTabs = NAV_ITEMS.filter(item => hasPermission(item.permission));
```

### 4.5 页面级权限控制

```typescript
// AppMobile.tsx
const renderContent = () => {
  const { hasPermission } = usePermissions(currentUser?.role || []);

  // 无权限时显示提示
  if (!hasPermission(PERMISSIONS.VIEW_DASHBOARD) && activeTab === 'DASHBOARD') {
    return <NoPermissionView />;
  }

  // 管理功能权限检查
  if (activeTab === 'USERS' && !hasPermission(PERMISSIONS.MANAGE_USERS)) {
    return <NoPermissionView />;
  }
  
  // ... 其他页面权限检查
};
```

## 五、实施步骤

### 任务 1：创建权限配置文件
- 创建 `permissions.ts` 定义权限常量和角色映射
- 定义所有功能权限和数据权限

### 任务 2：创建权限 Hook
- 创建 `usePermissions.ts` Hook
- 实现 `hasPermission`、`hasRole` 等方法

### 任务 3：创建权限守卫组件
- 创建 `PermissionGuard.tsx` 组件
- 支持单权限和多权限检查

### 任务 4：改造底部导航栏
- 为每个导航项添加权限要求
- 根据用户权限动态显示导航项

### 任务 5：改造个人中心
- 为每个菜单项添加权限要求
- 根据用户权限动态显示菜单项

### 任务 6：添加页面级权限控制
- 在 AppMobile 中添加权限检查
- 创建无权限提示页面

### 任务 7：添加数据权限控制
- 在预约列表中根据权限过滤数据
- 在审批功能中检查审批权限

### 任务 8：测试验证
- 测试各角色的功能访问
- 测试数据权限隔离

## 六、无权限提示页面

```typescript
// NoPermissionView.tsx
export const NoPermissionView = () => (
  <div className="flex flex-col items-center justify-center h-full p-8">
    <ShieldOff size={64} className="text-gray-300 mb-4" />
    <h2 className="text-lg font-bold text-gray-600 mb-2">无访问权限</h2>
    <p className="text-sm text-gray-400 text-center">
      您没有权限访问此功能，请联系管理员获取相应权限
    </p>
  </div>
);
```

## 七、预期效果

### 7.1 正式员工视角
- 底部导航：首页、资源、我的
- 个人中心：我的申请、个人信息

### 7.2 会议服务视角
- 底部导航：首页、资源、会议服务、我的
- 个人中心：我的申请、个人信息
- 会议服务：查看所有会议室预约

### 7.3 审批负责人视角
- 底部导航：首页、资源、审批、我的
- 个人中心：我的申请、个人信息
- 审批中心：审批所有预约申请

### 7.4 系统管理员视角
- 底部导航：首页、资源、会议服务、审批、我的
- 个人中心：我的申请、个人信息、成员中心、角色管理、部门管理、资源管理、流程配置、数据中心
- 全部数据访问权限
